---
title: "Generate Coupon from Points"
api: "POST /loyalty/coupons/generate"
description: "Convert customer loyalty points into a usable coupon for a specific reward"
---

## Overview

This endpoint allows customers to redeem their loyalty points for specific rewards by generating a coupon. The system validates the customer has sufficient points, deducts the required points, and creates a new coupon with expiration date and terms. This is the primary way customers convert their earned points into tangible benefits.

## Authentication

<ParamField header="Authorization" type="string" required>
  Bearer token for API authentication
  ```
  Authorization: Bearer {your_api_key}
  ```
</ParamField>

## Request Body

<ParamField body="member_id" type="string" required>
  Unique Zupy customer identifier
  ```
  ZP-4F95FB0A
  ```
</ParamField>

<ParamField body="reward_id" type="string" required>
  Unique reward identifier from the rewards catalog
  ```
  rw_pizza_margherita
  ```
</ParamField>

<ParamField body="restaurant_id" type="string" required>
  Company identifier for the reward redemption
  ```
  comp_bella_vista
  ```
</ParamField>

## Response

<ResponseField name="success" type="boolean">
  Whether the coupon was successfully generated
</ResponseField>

<ResponseField name="coupon_code" type="string">
  Unique coupon code generated (format: CP-XXXXXXXX)
</ResponseField>

<ResponseField name="member_id" type="string">
  Customer identifier who redeemed the points
</ResponseField>

<ResponseField name="reward" type="object">
  Details about the reward that was redeemed
  
  <Expandable title="Reward Details">
    <ResponseField name="name" type="string">
      Display name of the reward
    </ResponseField>
    
    <ResponseField name="description" type="string">
      Detailed description of what the customer receives
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="points_debited" type="integer">
  Number of points deducted from customer's balance
</ResponseField>

<ResponseField name="expires_at" type="string">
  Coupon expiration date and time (ISO 8601)
</ResponseField>

<ResponseField name="new_balance" type="integer">
  Customer's remaining points balance after redemption
</ResponseField>

## Example Request

<CodeGroup>
```bash cURL
curl -X POST "https://api.zupy.com/v1/loyalty/coupons/generate" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "member_id": "ZP-4F95FB0A",
    "reward_id": "rw_pizza_margherita",
    "restaurant_id": "comp_bella_vista"
  }'
```

```javascript JavaScript
const response = await fetch('https://api.zupy.com/v1/loyalty/coupons/generate', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    member_id: 'ZP-4F95FB0A',
    reward_id: 'rw_pizza_margherita',
    restaurant_id: 'comp_bella_vista'
  })
});

const coupon = await response.json();
console.log(coupon);
```

```python Python
import requests

url = "https://api.zupy.com/v1/loyalty/coupons/generate"
headers = {
    "Authorization": "Bearer YOUR_API_KEY",
    "Content-Type": "application/json"
}
data = {
    "member_id": "ZP-4F95FB0A",
    "reward_id": "rw_pizza_margherita",
    "restaurant_id": "comp_bella_vista"
}

response = requests.post(url, headers=headers, json=data)
coupon = response.json()
print(coupon)
```

```php PHP
<?php
$url = "https://api.zupy.com/v1/loyalty/coupons/generate";

$headers = [
    "Authorization: Bearer YOUR_API_KEY",
    "Content-Type: application/json"
];

$data = [
    "member_id" => "ZP-4F95FB0A",
    "reward_id" => "rw_pizza_margherita",
    "restaurant_id" => "comp_bella_vista"
];

$response = file_get_contents($url, false, stream_context_create([
    'http' => [
        'method' => 'POST',
        'header' => implode("\r\n", $headers),
        'content' => json_encode($data)
    ]
]));

$coupon = json_decode($response, true);
print_r($coupon);
?>
```
</CodeGroup>

## Example Response

<CodeGroup>
```json 200 - Coupon Generated Successfully
{
  "success": true,
  "coupon_code": "CP-F8G9H0I1",
  "member_id": "ZP-4F95FB0A",
  "reward": {
    "name": "Pizza Margherita Grátis",
    "description": "Pizza Margherita tradicional completa com molho de tomate, mussarela e manjericão fresco"
  },
  "points_debited": 1000,
  "expires_at": "2025-09-26T23:59:59Z",
  "new_balance": 150
}
```

```json 200 - Percentage Discount Coupon
{
  "success": true,
  "coupon_code": "CP-K2L3M4N5",
  "member_id": "ZP-4F95FB0A",
  "reward": {
    "name": "10% de Desconto",
    "description": "10% de desconto em qualquer pedido"
  },
  "points_debited": 500,
  "expires_at": "2025-09-26T23:59:59Z",
  "new_balance": 650
}
```

```json 400 - Insufficient Points
{
  "success": false,
  "error": "insufficient_points",
  "message": "Cliente possui 750 pontos, mas precisa de 1000 pontos para esta recompensa",
  "customer_balance": 750,
  "required_points": 1000
}
```

```json 400 - Reward Not Available
{
  "success": false,
  "error": "reward_not_available",
  "message": "Recompensa 'rw_pizza_margherita' está temporariamente indisponível"
}
```

```json 404 - Customer Not Found
{
  "success": false,
  "error": "customer_not_found",
  "message": "Cliente com member_id 'ZP-INVALID1' não encontrado"
}
```
</CodeGroup>

## Generation Rules

### Point Validation
- **Sufficient Balance**: Customer must have enough points for reward
- **Active Account**: Customer account must be active
- **Point Expiration**: Expired points cannot be used for redemption
- **Minimum Balance**: Optional minimum balance retention rules

### Reward Availability
- **Stock Check**: Limited availability rewards must be in stock
- **Seasonal Limits**: Seasonal rewards only available during valid periods
- **Tier Restrictions**: Some rewards may be tier-specific
- **Company Match**: Reward must belong to requesting company

### Coupon Creation
- **Unique Code**: Each coupon gets unique 8-character code
- **Expiration**: Based on company policy (typically 30 days)
- **Terms Inheritance**: Terms copied from reward configuration
- **Audit Trail**: Full redemption history maintained

## Expiration Rules

### Standard Coupons
- **Default Duration**: 30 days from generation
- **Company Policy**: Configurable per company (7-90 days)
- **Timezone**: Company's local timezone used
- **Grace Period**: No grace period after expiration

### Special Cases
- **Seasonal Rewards**: May have shorter expiration
- **Holiday Specials**: Tied to promotion end date
- **High-Value Items**: May have longer expiration (45-60 days)
- **Weekend Only**: Valid only Friday-Sunday

## Mobile App Integration

### Reward Selection Flow
```javascript
const generateCoupon = async (rewardId) => {
  // Step 1: Show loading state
  showLoadingMessage("Gerando seu cupom...");
  
  try {
    // Step 2: Generate the coupon
    const response = await fetch('/loyalty/coupons/generate', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer USER_TOKEN',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        member_id: getCurrentMemberId(),
        reward_id: rewardId,
        restaurant_id: getCurrentRestaurantId()
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Step 3: Show success and add to wallet
      addCouponToWallet(result);
      showSuccessMessage(`Cupom gerado! Código: ${result.coupon_code}`);
      
      // Step 4: Update points balance
      updatePointsBalance(result.new_balance);
      
      // Step 5: Navigate to coupon details
      navigateToCouponDetails(result.coupon_code);
      
      return { success: true, coupon: result };
    } else {
      handleGenerationError(result.error, result.message);
      return { success: false, error: result.error };
    }
    
  } catch (error) {
    showErrorMessage("Erro de conexão. Tente novamente.");
    return { success: false, error: 'network_error' };
  } finally {
    hideLoadingMessage();
  }
};

const handleGenerationError = (error, message) => {
  const errorMessages = {
    'insufficient_points': 'Você não tem pontos suficientes para esta recompensa.',
    'reward_not_available': 'Esta recompensa está temporariamente indisponível.',
    'customer_not_found': 'Erro na sua conta. Entre em contato com o suporte.',
    'reward_not_found': 'Recompensa não encontrada.',
    'stock_unavailable': 'Esta recompensa está esgotada no momento.'
  };
  
  const userMessage = errorMessages[error] || message || 'Erro desconhecido';
  showErrorDialog({
    title: 'Não foi possível gerar o cupom',
    message: userMessage,
    actions: ['Tentar Novamente', 'Ver Outras Recompensas']
  });
};
```

### Coupon Wallet Display
```javascript
const addCouponToWallet = (couponData) => {
  const couponCard = `
    <div class="coupon-card new-coupon" data-code="${couponData.coupon_code}">
      <div class="coupon-header">
        <h3>${couponData.reward.name}</h3>
        <div class="coupon-code">${couponData.coupon_code}</div>
        <div class="new-badge">NOVO!</div>
      </div>
      <p class="coupon-description">${couponData.reward.description}</p>
      <div class="coupon-expiry">
        Válido até ${formatDate(couponData.expires_at)}
      </div>
      <div class="coupon-actions">
        <button onclick="showCouponQR('${couponData.coupon_code}')">
          Mostrar QR Code
        </button>
        <button onclick="shareCoupon('${couponData.coupon_code}')">
          Compartilhar
        </button>
      </div>
    </div>
  `;
  
  // Add to wallet with animation
  const walletContainer = document.getElementById('coupon-wallet');
  walletContainer.insertAdjacentHTML('afterbegin', couponCard);
  
  // Animate new coupon appearance
  setTimeout(() => {
    document.querySelector('.new-coupon').classList.add('show');
  }, 100);
};
```

### Points Balance Updates
```javascript
const updatePointsBalance = (newBalance) => {
  const balanceElement = document.getElementById('points-balance');
  const currentBalance = parseInt(balanceElement.textContent);
  
  // Animate the balance change
  animateNumberChange(balanceElement, currentBalance, newBalance);
  
  // Update progress bars and tier indicators
  updateTierProgress(newBalance);
  updateNextRewardProgress(newBalance);
  
  // Show points spent notification
  const pointsSpent = currentBalance - newBalance;
  showNotification(`${pointsSpent} pontos utilizados`, 'success');
};

const animateNumberChange = (element, fromValue, toValue) => {
  const duration = 1000; // 1 second
  const steps = 30;
  const stepDuration = duration / steps;
  const stepSize = (toValue - fromValue) / steps;
  
  let currentStep = 0;
  
  const timer = setInterval(() => {
    currentStep++;
    const currentValue = Math.round(fromValue + (stepSize * currentStep));
    element.textContent = currentValue.toLocaleString('pt-BR');
    
    if (currentStep >= steps) {
      clearInterval(timer);
      element.textContent = toValue.toLocaleString('pt-BR');
    }
  }, stepDuration);
};
```

## Business Logic

### Point Deduction Process
1. **Validation**: Verify customer has sufficient points
2. **Reservation**: Temporarily hold required points
3. **Generation**: Create coupon with unique code
4. **Deduction**: Permanently deduct points from balance
5. **Notification**: Send confirmation to customer

### Reward Inventory Management
- **Stock Tracking**: Decrement available stock for limited rewards
- **Availability Rules**: Check seasonal and tier restrictions
- **Fallback Options**: Suggest alternative rewards when unavailable

### Customer Experience
- **Immediate Access**: Coupon available instantly in app
- **Clear Instructions**: Usage terms and expiration clearly displayed
- **Easy Sharing**: QR codes and sharing options
- **Expiration Reminders**: Notifications before coupon expires

## Webhook Integration

### Coupon Generated Event
When a coupon is successfully generated, the system can trigger a webhook:

```json
{
  "event": "coupon.generated",
  "timestamp": "2025-08-26T15:30:00Z",
  "company_id": "comp_bella_vista",
  "customer": {
    "member_id": "ZP-4F95FB0A",
    "name": "João Silva",
    "tier": "silver"
  },
  "generation": {
    "coupon_code": "CP-F8G9H0I1",
    "reward_name": "Pizza Margherita Grátis",
    "points_spent": 1000,
    "new_points_balance": 150,
    "expires_at": "2025-09-26T23:59:59Z"
  }
}
```

This enables:
- **CRM Integration**: Update customer profiles with redemption history
- **Marketing Automation**: Trigger follow-up campaigns
- **Analytics**: Track reward popularity and redemption patterns
- **Inventory Systems**: Update stock levels for physical rewards

## Analytics and Reporting

### Key Metrics
- **Redemption Rate**: Points converted to coupons vs total points earned
- **Popular Rewards**: Most frequently generated coupon types
- **Time to Redemption**: Average time between earning and spending points
- **Expiration Rate**: Percentage of coupons that expire unused

### Business Intelligence
- **Customer Segments**: Identify high-value vs frequent redeemers
- **Reward Optimization**: Adjust point costs based on demand
- **Inventory Planning**: Forecast reward inventory needs
- **Campaign Effectiveness**: Measure impact of promotional rewards

## Error Codes

| Code | Description |
|------|-------------|
| `insufficient_points` | Customer doesn't have enough points |
| `reward_not_found` | Reward ID doesn't exist |
| `reward_not_available` | Reward is out of stock or inactive |
| `customer_not_found` | Customer doesn't exist or is inactive |
| `stock_unavailable` | Limited reward is out of stock |
| `tier_restricted` | Reward not available for customer's tier |
| `generation_limit_exceeded` | Customer exceeded daily/monthly generation limits |
| `unauthorized` | Missing or invalid API credentials |

## Rate Limits

- **Production**: 30 requests per minute per customer (to prevent abuse)
- **Staging**: 10 requests per minute per customer

<Tip>
  **Pre-Generation Validation**: Use the rewards catalog endpoint to verify reward availability and customer point balance before attempting generation.
</Tip>

<Warning>
  **Irreversible Transaction**: Point deduction and coupon generation cannot be undone through the API. Ensure proper validation before calling this endpoint.
</Warning>
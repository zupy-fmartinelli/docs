---
title: "Record Loyalty Transaction"
api: "POST /loyalty/transactions"
description: "Register a customer transaction and award loyalty points based on company configuration and automatic modifiers"
---

## Overview

This endpoint processes customer transactions and awards loyalty points based on the company's configured conversion rules. The system automatically calculates points using the base conversion rate, applies rounding rules, and includes any active modifiers (item bonuses, time-based multipliers, RFM segments, campaigns).

<Note>
  **Automatic Calculation**: Points are calculated using: `base_points = transaction_value × points_per_currency_unit`, then rounding is applied according to company configuration, followed by modifier multipliers.
</Note>

## Authentication

<ParamField header="Authorization" type="string" required>
  Bearer token for API authentication
  ```
  Authorization: Bearer {your_api_key}
  ```
</ParamField>

## Request Body

<ParamField body="member_id" type="string" required>
  Zupy customer identifier
  ```
  ZP-4F95FB0A
  ```
</ParamField>

<ParamField body="company_id" type="string" required>
  Company identifier for points calculation
  ```
  comp_bella_vista
  ```
</ParamField>

<ParamField body="transaction_type" type="string" required>
  Type of transaction being recorded
  ```
  purchase | return | adjustment | bonus
  ```
</ParamField>

<ParamField body="order" type="object" required>
  Order details for points calculation
  
  <Expandable title="Order Object">
    <ParamField body="order_id" type="string" required>
      Unique order identifier
    </ParamField>
    
    <ParamField body="total_value" type="number" required>
      Total order value in BRL for points calculation
    </ParamField>
    
    <ParamField body="currency" type="string" required>
      Currency code (always "BRL")
    </ParamField>
    
    <ParamField body="items" type="array" required>
      Array of order items
      
      <Expandable title="Item Object">
        <ParamField body="name" type="string" required>
          Item name
        </ParamField>
        
        <ParamField body="price" type="number" required>
          Item price in BRL
        </ParamField>
        
        <ParamField body="category" type="string">
          Item category for bonus calculation
        </ParamField>
        
        <ParamField body="quantity" type="integer" required>
          Item quantity
        </ParamField>
      </Expandable>
    </ParamField>
    
    <ParamField body="payment_method" type="string">
      Payment method used
      ```
      credit_card | debit_card | pix | cash | voucher
      ```
    </ParamField>
    
    <ParamField body="platform" type="string" required>
      Platform where transaction occurred
      ```
      goomer | repediu | ifood | manual | pos
      ```
    </ParamField>
  </Expandable>
</ParamField>

<ParamField body="context" type="object">
  Transaction context for modifier calculation
  
  <Expandable title="Context Object">
    <ParamField body="timestamp" type="string">
      Transaction timestamp (ISO 8601)
    </ParamField>
    
    <ParamField body="day_of_week" type="string">
      Day of the week for time-based bonuses
      ```
      monday | tuesday | wednesday | thursday | friday | saturday | sunday
      ```
    </ParamField>
    
    <ParamField body="hour" type="integer">
      Hour of day (0-23) for time-based bonuses
    </ParamField>
    
    <ParamField body="active_campaigns" type="array">
      List of active campaign identifiers
    </ParamField>
    
    <ParamField body="location" type="string">
      Transaction location
      ```
      store | online | delivery
      ```
    </ParamField>
  </Expandable>
</ParamField>

## Response

<ResponseField name="transaction_id" type="string">
  Unique transaction identifier
</ResponseField>

<ResponseField name="member_id" type="string">
  Customer identifier
</ResponseField>

<ResponseField name="points" type="object">
  Points calculation details
  
  <Expandable title="Points Object">
    <ResponseField name="base_points" type="integer">
      Points calculated from transaction value before modifiers
    </ResponseField>
    
    <ResponseField name="final_points" type="integer">
      Final points awarded after all modifiers and rounding
    </ResponseField>
    
    <ResponseField name="modifiers_applied" type="array">
      List of modifiers that were applied
    </ResponseField>
    
    <ResponseField name="previous_balance" type="integer">
      Customer's points balance before this transaction
    </ResponseField>
    
    <ResponseField name="new_balance" type="integer">
      Customer's points balance after this transaction
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="new_tier_achieved" type="string">
  New loyalty tier if customer was promoted (null if no change)
</ResponseField>

<ResponseField name="next_reward_progress" type="object">
  Progress towards next available reward
  
  <Expandable title="Next Reward Progress">
    <ResponseField name="reward_name" type="string">
      Name of the next achievable reward
    </ResponseField>
    
    <ResponseField name="points_needed" type="integer">
      Points needed to reach this reward
    </ResponseField>
    
    <ResponseField name="progress_percentage" type="number">
      Progress percentage towards this reward (0-100)
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="rfm_update" type="object">
  RFM classification changes
  
  <Expandable title="RFM Update">
    <ResponseField name="previous" type="string">
      Previous RFM classification
    </ResponseField>
    
    <ResponseField name="current" type="string">
      Current RFM classification after this transaction
    </ResponseField>
    
    <ResponseField name="upgrade" type="boolean">
      Whether this was an RFM upgrade
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="coupons_generated" type="array">
  List of coupons automatically generated from this transaction
</ResponseField>

## Example Request

<CodeGroup>
```bash cURL
curl -X POST "https://api.zupy.com/v1/loyalty/transactions" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "member_id": "ZP-4F95FB0A",
    "company_id": "comp_bella_vista",
    "transaction_type": "purchase",
    "order": {
      "order_id": "ord_12345",
      "total_value": 35.00,
      "currency": "BRL",
      "items": [
        {
          "name": "Pizza Margherita",
          "price": 35.00,
          "category": "pizza",
          "quantity": 1
        }
      ],
      "payment_method": "credit_card",
      "platform": "goomer"
    },
    "context": {
      "timestamp": "2025-08-26T15:30:00Z",
      "day_of_week": "monday",
      "hour": 15,
      "active_campaigns": ["semana_italiana"],
      "location": "delivery"
    }
  }'
```

```javascript JavaScript
const response = await fetch('https://api.zupy.com/v1/loyalty/transactions', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    member_id: 'ZP-4F95FB0A',
    company_id: 'comp_bella_vista',
    transaction_type: 'purchase',
    order: {
      order_id: 'ord_12345',
      total_value: 35.00,
      currency: 'BRL',
      items: [
        {
          name: 'Pizza Margherita',
          price: 35.00,
          category: 'pizza',
          quantity: 1
        }
      ],
      payment_method: 'credit_card',
      platform: 'goomer'
    },
    context: {
      timestamp: '2025-08-26T15:30:00Z',
      day_of_week: 'monday',
      hour: 15,
      active_campaigns: ['semana_italiana'],
      location: 'delivery'
    }
  })
});

const result = await response.json();
console.log(result);
```

```python Python
import requests

url = "https://api.zupy.com/v1/loyalty/transactions"
headers = {
    "Authorization": "Bearer YOUR_API_KEY",
    "Content-Type": "application/json"
}

payload = {
    "member_id": "ZP-4F95FB0A",
    "company_id": "comp_bella_vista",
    "transaction_type": "purchase",
    "order": {
        "order_id": "ord_12345",
        "total_value": 35.00,
        "currency": "BRL",
        "items": [
            {
                "name": "Pizza Margherita",
                "price": 35.00,
                "category": "pizza",
                "quantity": 1
            }
        ],
        "payment_method": "credit_card",
        "platform": "goomer"
    },
    "context": {
        "timestamp": "2025-08-26T15:30:00Z",
        "day_of_week": "monday",
        "hour": 15,
        "active_campaigns": ["semana_italiana"],
        "location": "delivery"
    }
}

response = requests.post(url, json=payload, headers=headers)
result = response.json()
print(result)
```

```php PHP
<?php
$url = "https://api.zupy.com/v1/loyalty/transactions";

$headers = [
    "Authorization: Bearer YOUR_API_KEY",
    "Content-Type: application/json"
];

$payload = [
    "member_id" => "ZP-4F95FB0A",
    "company_id" => "comp_bella_vista",
    "transaction_type" => "purchase",
    "order" => [
        "order_id" => "ord_12345",
        "total_value" => 35.00,
        "currency" => "BRL",
        "items" => [
            [
                "name" => "Pizza Margherita",
                "price" => 35.00,
                "category" => "pizza",
                "quantity" => 1
            ]
        ],
        "payment_method" => "credit_card",
        "platform" => "goomer"
    ],
    "context" => [
        "timestamp" => "2025-08-26T15:30:00Z",
        "day_of_week" => "monday",
        "hour" => 15,
        "active_campaigns" => ["semana_italiana"],
        "location" => "delivery"
    ]
];

$response = file_get_contents($url, false, stream_context_create([
    'http' => [
        'method' => 'POST',
        'header' => implode("\r\n", $headers),
        'content' => json_encode($payload)
    ]
]));

$result = json_decode($response, true);
print_r($result);
?>
```
</CodeGroup>

## Example Response

<CodeGroup>
```json 201 - Transaction Successful
{
  "transaction_id": "tx_789ABC123",
  "member_id": "ZP-4F95FB0A",
  "points": {
    "base_points": 35,
    "final_points": 35,
    "modifiers_applied": [],
    "previous_balance": 847,
    "new_balance": 882
  },
  "new_tier_achieved": null,
  "next_reward_progress": {
    "reward_name": "Refrigerante Grátis",
    "points_needed": 118,
    "progress_percentage": 79.3
  },
  "rfm_update": {
    "previous": "Loyal Customer",
    "current": "Champion",
    "upgrade": true
  },
  "coupons_generated": []
}
```

```json 201 - Transaction with Modifiers
{
  "transaction_id": "tx_890DEF456",
  "member_id": "ZP-8B23CD41",
  "points": {
    "base_points": 35,
    "final_points": 68,
    "modifiers_applied": [
      {
        "type": "category_bonus",
        "category": "pizza",
        "multiplier": 1.5,
        "description": "Bônus categoria pizza"
      },
      {
        "type": "campaign_bonus", 
        "campaign": "semana_italiana",
        "multiplier": 1.3,
        "description": "Semana Italiana - 30% extra"
      }
    ],
    "previous_balance": 150,
    "new_balance": 218
  },
  "new_tier_achieved": "silver",
  "next_reward_progress": {
    "reward_name": "Pizza Individual Grátis",
    "points_needed": 82,
    "progress_percentage": 62.7
  },
  "rfm_update": {
    "previous": "New Customer",
    "current": "New Customer",
    "upgrade": false
  },
  "coupons_generated": [
    {
      "coupon_code": "CP-A1B2C3D4",
      "reward_name": "Desconto 10% próxima compra",
      "trigger": "tier_upgrade",
      "expires_at": "2025-09-26T15:30:00Z"
    }
  ]
}
```

```json 400 - Below Minimum Transaction
{
  "error": "transaction_below_minimum",
  "message": "Valor da transação abaixo do mínimo configurado",
  "details": {
    "transaction_value": 2.50,
    "minimum_required": 5.00,
    "points_awarded": 0
  }
}
```

```json 404 - Customer Not Found
{
  "error": "customer_not_found",
  "message": "Cliente não encontrado",
  "details": {
    "member_id": "ZP-INVALID1"
  }
}
```
</CodeGroup>

## Points Calculation Examples

Based on company configuration, here's how points are calculated:

### Example A: Simple Calculation
```
Company Config: 10 points/real, round_down, minimum R$ 1.00
Transaction: R$ 35.00
Calculation: 35.00 × 10 = 350.0 → 350 points (round_down)
Final: 350 points awarded
```

### Example B: With Category Bonus
```
Company Config: 10 points/real, round_down
Transaction: R$ 35.00 pizza
Category Bonus: pizza = 1.5× multiplier
Calculation: (35.00 × 10) × 1.5 = 350 × 1.5 = 525 points
Final: 525 points awarded
```

### Example C: Multiple Modifiers
```
Company Config: 10 points/real, round_down
Transaction: R$ 35.00 pizza on Monday during "semana_italiana"
Modifiers: pizza (1.5×) + campaign (1.3×)
Calculation: (35.00 × 10) × 1.5 × 1.3 = 682.5 → 682 points
Final: 682 points awarded
```

### Example D: RFM Multiplier
```
Company Config: 10 points/real + RFM tiers
Customer: Champion tier (1.2× RFM multiplier)
Transaction: R$ 35.00
Calculation: (35.00 × 10) × 1.2 = 420 points
Final: 420 points awarded
```

## Available Modifiers

<ResponseField name="category_bonus">
  **Category Bonus**: Multiplier based on item category (pizza, beverage, dessert)
</ResponseField>

<ResponseField name="campaign_bonus">
  **Campaign Bonus**: Active promotional campaign multipliers
</ResponseField>

<ResponseField name="time_bonus">
  **Time Bonus**: Day of week or hour-based bonuses (happy hour, weekend)
</ResponseField>

<ResponseField name="rfm_multiplier">
  **RFM Multiplier**: Customer segment-based bonus (Champion, Loyal, etc.)
</ResponseField>

<ResponseField name="payment_bonus">
  **Payment Bonus**: Payment method incentives (PIX, digital wallet)
</ResponseField>

<ResponseField name="platform_bonus">
  **Platform Bonus**: Channel-specific bonuses (online, app, delivery)
</ResponseField>

## Business Rules

### Transaction Processing
- **Minimum Value**: Transactions below company's `minimum_transaction` earn 0 points
- **Rounding**: Applied after base calculation but before modifiers
- **Modifiers**: Applied sequentially (multiplicative, not additive)
- **Currency**: Only BRL supported currently

### Automatic Actions
- **Tier Upgrades**: Calculated based on total points or RFM changes
- **RFM Updates**: Recalculated after each transaction
- **Coupon Generation**: Triggered by tier changes, milestones, or campaigns
- **Reward Progress**: Updated to show next achievable reward

### Data Validation
- **Member ID**: Must exist and be active
- **Company ID**: Must match customer's associated company
- **Order Total**: Must match sum of item prices × quantities
- **Currency**: Must be "BRL"

## Error Codes

| Code | Description |
|------|-------------|
| `customer_not_found` | Customer doesn't exist or is inactive |
| `company_not_found` | Invalid company_id provided |
| `company_mismatch` | Customer not associated with this company |
| `transaction_below_minimum` | Transaction value below minimum threshold |
| `invalid_currency` | Currency other than BRL provided |
| `duplicate_transaction` | Transaction with same order_id already processed |
| `calculation_error` | Error in points calculation engine |

## Rate Limits

- **Production**: 1000 transactions per minute per company
- **Staging**: 200 transactions per minute per company

<Warning>
  **Idempotency**: Use unique `order_id` values to prevent duplicate transactions. The system will reject transactions with duplicate order IDs within the same company.
</Warning>

<Tip>
  **Performance Tip**: Include all available context data for more accurate modifier calculations and better customer segmentation.
</Tip>